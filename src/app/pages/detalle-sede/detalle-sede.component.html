<div class="dashboard-container">
  <!-- ğŸ“Œ BotÃ³n de menÃº para dispositivos mÃ³viles -->
  <button class="menu-toggle" (click)="toggleSidebar()">â˜°</button>

  <!-- ğŸ“Œ Fondo semitransparente al abrir el sidebar -->
  <div class="sidebar-overlay" [class.active]="sidebarAbierto" (click)="toggleSidebar()"></div>

  <!-- ğŸ“Œ Sidebar -->
  <div class="sidebar" [class.active]="sidebarAbierto">
    <h3>Detalle de Sede</h3>
    <ul class="nav flex-column">
      <li class="nav-item"><button class="btn-sidebar" routerLink="/dashboard">ğŸ  Dashboard</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/sedes">ğŸ“ Sedes</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/trabajadores">ğŸ‘· Trabajadores</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/calendario-laboral">ğŸ“… Calendario Laboral</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/acerca-de">â„¹ï¸ Acerca de</button></li>
      <li class="nav-item" *ngIf="esAdmin()">
        <button class="btn-sidebar" routerLink="/admin-dashboard">ğŸ§‘â€ğŸ’¼ Ver Usuarios</button>
      </li>
    </ul>
    <button class="btn-logout" (click)="cerrarSesion()">âŒ Cerrar SesiÃ³n</button>
  </div>

  <!-- ğŸ“Œ Contenido principal -->
  <div class="main-content">
        <!-- ğŸš¨ Alerta de sede en proceso de eliminaciÃ³n -->
    <div *ngIf="sede?.estado === 'eliminacion_pendiente'" class="alerta-pendiente">
      âš ï¸ Esta sede estÃ¡ en proceso de eliminaciÃ³n. Tienes 15 dÃ­as para cancelarlo antes de que se elimine automÃ¡ticamente.
    </div>
    <div class="welcome-card">
      <h2>{{ sede?.nombre }} (ID: {{ sede?.id }})</h2>
      <p>AdministraciÃ³n de datos de la sede.</p>
    </div>

    <div class="botones-descarga" style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px;">
      <!-- ğŸ“„ BotÃ³n para generar PDF -->
      <button class="btn btn--danger"
        style="background-color: #a30202; color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;"
        (click)="generarPdfPorSede()">
        ğŸ“„ Descargar PDF de asistencias
      </button>

      <!-- ğŸ“Š BotÃ³n para generar Excel -->
      <button class="btn btn--success"
        style="background-color: #16861a; color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;"
        (click)="abrirSelectorDeFechasExcel()">
        ğŸ“Š Generar Excel por sede
      </button>
    </div>

    <p></p>

    <div class="card">
      <h3>ğŸ“ InformaciÃ³n de la sede</h3>
      <form class="form-sede">
        <div class="form-group">
          <label>ID:</label>
          <input type="text" [value]="sede?.id" disabled />
        </div>
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" [value]="sede?.nombre" disabled />
        </div>
        <div class="form-group">
          <label>DirecciÃ³n:</label>
          <input [(ngModel)]="sede.direccion" name="direccion" [disabled]="esSoloRevisor()" [ngClass]="{'input-disabled': esSoloRevisor()}" />
        </div>
        <div class="form-group">
          <label>Zona:</label>
          <input [(ngModel)]="sede.zona" name="zona" [disabled]="esSoloRevisor()" [ngClass]="{'input-disabled': esSoloRevisor()}" />
        </div>
        <div class="form-group">
          <label>Responsable:</label>
          <input [(ngModel)]="sede.responsable" name="responsable" [disabled]="esSoloRevisor()" [ngClass]="{'input-disabled': esSoloRevisor()}" />
        </div>
        <button class="btn btn--primary" (click)="guardarCambios()" *ngIf="!esSoloRevisor()">
          <i class="bi bi-save"></i> Guardar Cambios
        </button>
      </form>
    </div>
    <!-- AcordeÃ³n general -->
    <mat-accordion class="acordeon-general content-card">
      <mat-expansion-panel class="panel-horario-base" [expanded]="false">
        <mat-expansion-panel-header>
          <mat-panel-title>Horario base</mat-panel-title>
          <mat-panel-description class="muted" *ngIf="form?.value?.desde as f">
            Desde: {{ f | date:'dd/MM/yyyy' }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- Contenido del panel -->
        <mat-card class="content-card">
          <mat-card-content>
            <form [formGroup]="form" (ngSubmit)="guardar()">
              <!-- Barra superior: fecha + botÃ³n -->
              <div class="toolbar-horario">
                <mat-form-field appearance="outline" class="fecha-inicio">
                  <mat-label>Fecha de inicio</mat-label>
                  <input matInput [matDatepicker]="dp" formControlName="desde" autocomplete="off">
                  <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
                  <mat-datepicker #dp></mat-datepicker>
                </mat-form-field>

                <span class="grow"></span>

                <button type="button" class="btn btn--pill" (click)="aplicarATodos()">
                  Copiar primer dÃ­a a todos
                </button>
              </div>

              <!-- AcordeÃ³n de dÃ­as -->
              <mat-accordion class="horario-accordion" displayMode="flat" multi>
                <ng-container formArrayName="dias">
                  <mat-expansion-panel
                    class="dia-panel"
                    *ngFor="let diaCtrl of dias.controls; let i = index; trackBy: trackByIndex"
                    [formGroupName]="i"
                    [expanded]="false">

                    <mat-expansion-panel-header>
                      <mat-panel-title class="panel-title">
                        {{ nombresDias[i] }}
                      </mat-panel-title>

                      <mat-panel-description class="panel-desc">
                        <span class="estado-pill" [class.inactivo]="!diaCtrl.value.activo">
                          {{ diaCtrl.value.activo ? 'Activo' : 'Inactivo' }}
                        </span>
                        <span class="resumen"
                              *ngIf="diaCtrl.value.activo && diaCtrl.value.ini && diaCtrl.value.fin">
                          â€¢ {{ diaCtrl.value.ini }} â€“ {{ diaCtrl.value.fin }}
                        </span>
                      </mat-panel-description>
                    </mat-expansion-panel-header>

                    <div class="panel-body" [class.desactivado]="!diaCtrl.value.activo">
                      <div class="fila-top">
                        <mat-slide-toggle formControlName="activo">DÃ­a activo</mat-slide-toggle>
                      </div>

                      <div class="campos-hora">
                        <!-- Entrada -->
                        <mat-form-field appearance="outline">
                          <mat-label>Entrada</mat-label>
                          <input
                            matInput
                            formControlName="ini"
                            [ngxMatTimepicker]="pickerIni"
                            [format]="12"
                            placeholder="hh:mm AM/PM"
                            readonly>
                          <button
                            type="button"
                            mat-icon-button
                            matSuffix
                            (click)="pickerIni.open()"
                            [disabled]="!diaCtrl.value.activo">
                            <mat-icon>schedule</mat-icon>
                          </button>
                          <ngx-mat-timepicker #pickerIni></ngx-mat-timepicker>
                        </mat-form-field>

                        <!-- Salida -->
                        <mat-form-field appearance="outline">
                          <mat-label>Salida</mat-label>
                          <input
                            matInput
                            formControlName="fin"
                            [ngxMatTimepicker]="pickerFin"
                            [format]="12"
                            placeholder="hh:mm AM/PM"
                            readonly>
                          <button
                            type="button"
                            mat-icon-button
                            matSuffix
                            (click)="pickerFin.open()"
                            [disabled]="!diaCtrl.value.activo">
                            <mat-icon>schedule</mat-icon>
                          </button>
                          <ngx-mat-timepicker #pickerFin></ngx-mat-timepicker>
                        </mat-form-field>
                      </div>
                    </div>
                  </mat-expansion-panel>
                </ng-container>
              </mat-accordion>

              <!-- Botones -->
              <div class="acciones">
                <button type="button" mat-stroked-button color="warn" (click)="limpiar()">Limpiar</button>
                <button type="submit" mat-flat-button color="primary" [disabled]="form.invalid || guardando">
                  Guardar
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </mat-expansion-panel>
    </mat-accordion>
    <p></p>
    <div class="card">
      <h3>ğŸ‘¥ Trabajadores de esta sede</h3>
      <div class="search-container">
        <label class="search-label">ğŸ” Buscar por nombre o apellido:</label>
        <mat-form-field appearance="fill">
          <mat-label>Buscar trabajador</mat-label>
          <input matInput [(ngModel)]="busquedaTrabajador" placeholder="Nombre o apellido">
        </mat-form-field>
      </div>

      <table class="tabla-sedes">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let trabajador of trabajadoresFiltrados()">
            <td>{{ trabajador.id_checador }}</td>
            <td>{{ trabajador.nombre }}</td>
            <td>
              <button class="btn-view" (click)="verDetalleTrabajador(trabajador._id)">Ver</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>ğŸ“… Calendario laboral de la sede</h3>
      <app-calendario-sede
        [sede]="sede.id"
        [sedeNombre]="sede.nombre"
        [anio]="anioActual"
        [eventos]="eventos"
        [todasLasSedes]="todasLasSedes"
        (eventoGuardado)="guardarEventoDesdeCalendario($event)"
        (eventoEliminado)="eliminarEventoDesdeCalendario($event)">
      </app-calendario-sede>

      <button class="btn btn--primary btn--block" routerLink="/calendario-laboral" *ngIf="!esSoloRevisor()">
        <i class="bi bi-calendar-plus"></i> Modificar en Calendario Laboral
      </button>
    </div>

    <!-- ğŸ”¥ EliminaciÃ³n o cancelaciÃ³n de sede (solo Dios) -->
    <div class="card" *ngIf="esDios()">
      <h3 style="color: red;">âš ï¸ AcciÃ³n peligrosa</h3>
      <p *ngIf="sede.estado === 'activa'">
        Este botÃ³n eliminarÃ¡ la sede y todos sus trabajadores. AsegÃºrate de tener respaldo antes de continuar.
      </p>
      <p *ngIf="sede.estado === 'eliminacion_pendiente'">
        Esta sede estÃ¡ en proceso de eliminaciÃ³n. Tienes 15 dÃ­as para revertirlo antes de que se elimine permanentemente.
      </p>

      <button
        class="btn btn--danger btn--block"
        *ngIf="sede.estado === 'activa'"
        (click)="eliminarSede()">
        <i class="bi bi-trash-fill"></i> Eliminar Sede
      </button>

      <button
        class="btn-warning"
        *ngIf="sede.estado === 'eliminacion_pendiente'"
        (click)="cancelarEliminacionSede()">
        <i class="bi bi-arrow-counterclockwise"></i> Cancelar EliminaciÃ³n
      </button>
    </div>
  </div>
</div>
