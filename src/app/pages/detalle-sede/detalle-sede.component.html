<div class="dashboard-container">
  <!-- ‚ò∞ Bot√≥n de men√∫ (mobile) -->
  <button class="menu-toggle" (click)="toggleSidebar()" aria-label="Abrir men√∫ lateral">‚ò∞</button>

  <!-- Overlay (bloquea interacci√≥n al abrir sidebar) -->
  <div class="sidebar-overlay" [class.active]="sidebarAbierto" (click)="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" [class.active]="sidebarAbierto" aria-label="Navegaci√≥n lateral">
    <h3>Detalle de Sede</h3>
    <ul class="nav flex-column" role="menu">
      <li class="nav-item" role="none">
        <button class="btn-sidebar" routerLink="/dashboard" role="menuitem">üè† Dashboard</button>
      </li>
      <li class="nav-item" role="none">
        <button class="btn-sidebar" routerLink="/sedes" role="menuitem">üìç Sedes</button>
      </li>
      <li class="nav-item" role="none">
        <button class="btn-sidebar" routerLink="/trabajadores" role="menuitem">üë∑ Trabajadores</button>
      </li>
      <li class="nav-item" role="none">
        <button class="btn-sidebar" routerLink="/calendario-laboral" role="menuitem">üìÖ Calendario Laboral</button>
      </li>
      <li class="nav-item" role="none">
        <button class="btn-sidebar" routerLink="/acerca-de" role="menuitem">‚ÑπÔ∏è Acerca de</button>
      </li>
      <li class="nav-item" role="none" *ngIf="esAdmin()">
        <button class="btn-sidebar" routerLink="/admin-dashboard" role="menuitem">üßë‚Äçüíº Ver Usuarios</button>
      </li>
    </ul>
    <button class="btn-logout" (click)="cerrarSesion()">‚ùå Cerrar Sesi√≥n</button>
  </nav>

  <!-- Contenido principal -->
  <main class="main-content">
    <!-- Alerta de eliminaci√≥n pendiente -->
    <div *ngIf="sede?.estado === 'eliminacion_pendiente'" class="alerta-pendiente" role="alert">
      ‚ö†Ô∏è Esta sede est√° en proceso de eliminaci√≥n. Tienes 15 d√≠as para cancelarlo antes de que se elimine autom√°ticamente.
    </div>

    <!-- Bienvenida -->
    <div class="welcome-card">
      <h2>{{ sede?.nombre }} (ID: {{ sede?.id }})</h2>
      <p>Administraci√≥n de datos de la sede.</p>
    </div>

    <!-- Acciones de exportaci√≥n -->
    <div class="botones-descarga" style="display:flex;flex-wrap:wrap;gap:12px;margin-top:20px;">
      <button class="btn btn--danger"
              style="background-color:#a30202;color:white;border:none;padding:10px 16px;border-radius:6px;font-weight:bold;cursor:pointer;"
              (click)="generarPdfPorSede()">
        üìÑ Descargar PDF de asistencias
      </button>

      <button class="btn btn--success"
              style="background-color:#16861a;color:white;border:none;padding:10px 16px;border-radius:6px;font-weight:bold;cursor:pointer;"
              (click)="abrirSelectorDeFechasExcel()">
        üìä Generar Excel por sede
      </button>
    </div>

    <p></p>

    <!-- Informaci√≥n de la sede -->
    <div class="card">
      <h3>üìç Informaci√≥n de la sede</h3>
      <form class="form-sede">
        <div class="form-group">
          <label>ID:</label>
          <input type="text" [value]="sede?.id" disabled />
        </div>
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" [value]="sede?.nombre" disabled />
        </div>
        <div class="form-group">
          <label>Direcci√≥n:</label>
          <input [(ngModel)]="sede.direccion" name="direccion" [disabled]="esSoloRevisor()" [ngClass]="{'input-disabled': esSoloRevisor()}" />
        </div>
        <div class="form-group">
          <label>Zona:</label>
          <input [(ngModel)]="sede.zona" name="zona" [disabled]="esSoloRevisor()" [ngClass]="{'input-disabled': esSoloRevisor()}" />
        </div>
        <div class="form-group">
          <label>Responsable:</label>
          <input [(ngModel)]="sede.responsable" name="responsable" [disabled]="esSoloRevisor()" [ngClass]="{'input-disabled': esSoloRevisor()}" />
        </div>
        <button class="btn btn--primary" type="button" (click)="guardarCambios()" *ngIf="!esSoloRevisor()">
          <i class="bi bi-save"></i> Guardar Cambios
        </button>
      </form>
    </div>

    <!-- ===================== -->
    <!-- Acorde√≥n: Horario base -->
    <!-- ===================== -->
    <mat-accordion class="acordeon-general content-card">
      <mat-expansion-panel class="panel-horario-base" [expanded]="false">
        <mat-expansion-panel-header>
          <mat-panel-title>Horario base</mat-panel-title>
          <mat-panel-description class="muted" *ngIf="form?.value?.desde as f">
            Desde: {{ f | date:'dd/MM/yyyy' }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <mat-card class="content-card">
          <mat-card-content>
            <form [formGroup]="form" (ngSubmit)="guardar()">
              <!-- Barra superior -->
              <div class="toolbar-horario">
                <mat-form-field appearance="outline" class="fecha-inicio">
                  <mat-label>Fecha de inicio</mat-label>
                  <input matInput [matDatepicker]="dp" formControlName="desde" autocomplete="off" (dateChange)="onDatepickerOpened()">
                  <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
                  <mat-datepicker #dp></mat-datepicker>
                </mat-form-field>

                <span class="grow"></span>

                <button type="button" class="btn btn--pill" (click)="aplicarATodos()">
                  Copiar primer d√≠a a todos
                </button>
              </div>

              <!-- D√≠as de la semana -->
              <mat-accordion class="horario-accordion" displayMode="flat" multi>
                <ng-container formArrayName="dias">
                  <mat-expansion-panel
                    class="dia-panel"
                    *ngFor="let diaCtrl of dias.controls; let i = index; trackBy: trackByIndex"
                    [formGroupName]="i"
                    [expanded]="false">

                    <mat-expansion-panel-header>
                      <mat-panel-title class="panel-title">
                        {{ nombresDias[i] }}
                      </mat-panel-title>

                      <mat-panel-description class="panel-desc">
                        <span class="estado-pill" [class.inactivo]="!diaCtrl.value.activo">
                          {{ diaCtrl.value.activo ? 'Activo' : 'Inactivo' }}
                        </span>

                        <!-- Resumen: si hay jornadas, mostrar primera -->
                        <span class="resumen"
                              *ngIf="diaCtrl.value.activo && diaCtrl.value.jornadas?.length">
                          ‚Ä¢ {{ diaCtrl.value.jornadas[0]?.ini }} ‚Äì {{ diaCtrl.value.jornadas[0]?.fin }}
                          <ng-container *ngIf="diaCtrl.value.jornadas.length > 1">
                            (+{{ diaCtrl.value.jornadas.length - 1 }} m√°s)
                          </ng-container>
                        </span>
                      </mat-panel-description>
                    </mat-expansion-panel-header>

                    <div class="panel-body" [class.desactivado]="!diaCtrl.value.activo">
                      <div class="fila-top">
                        <mat-slide-toggle formControlName="activo">D√≠a activo</mat-slide-toggle>
                      </div>

                      <!-- FormArray de jornadas por d√≠a -->
                      <div class="jornadas-wrap" formArrayName="jornadas">
                        <div class="fila-jornada"
                             *ngFor="let jCtrl of getJornadas(i).controls; let jIdx = index"
                             [formGroupName]="jIdx">

                          <!-- Entrada -->
                          <mat-form-field appearance="outline">
                            <mat-label>Entrada</mat-label>
                            <input matInput formControlName="ini"
                                   [ngxMatTimepicker]="tpIni"
                                   [format]="12"
                                   placeholder="hh:mm AM/PM"
                                   readonly
                                   [disabled]="!diaCtrl.value.activo">
                            <button type="button" mat-icon-button matSuffix (click)="tpIni.open()" [disabled]="!diaCtrl.value.activo">
                              <mat-icon>schedule</mat-icon>
                            </button>
                            <ngx-mat-timepicker #tpIni></ngx-mat-timepicker>
                          </mat-form-field>

                          <!-- Salida -->
                          <mat-form-field appearance="outline">
                            <mat-label>Salida</mat-label>
                            <input matInput formControlName="fin"
                                   [ngxMatTimepicker]="tpFin"
                                   [format]="12"
                                   placeholder="hh:mm AM/PM"
                                   readonly
                                   [disabled]="!diaCtrl.value.activo">
                            <button type="button" mat-icon-button matSuffix (click)="tpFin.open()" [disabled]="!diaCtrl.value.activo">
                              <mat-icon>schedule</mat-icon>
                            </button>
                            <ngx-mat-timepicker #tpFin></ngx-mat-timepicker>
                          </mat-form-field>

                          <!-- Overnight -->
                          <mat-checkbox formControlName="overnight" [disabled]="!diaCtrl.value.activo">
                            Cruza medianoche
                          </mat-checkbox>

                          <!-- Quitar -->
                          <button type="button" mat-icon-button color="warn"
                                  aria-label="Quitar jornada"
                                  (click)="removeJornada(i, jIdx)"
                                  [disabled]="!diaCtrl.value.activo">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>

                        <!-- Agregar jornada -->
                        <button type="button" class="btn btn--glass btn--sm"
                                (click)="addJornada(i)"
                                [disabled]="!diaCtrl.value.activo">
                          + Agregar jornada
                        </button>
                      </div>
                    </div>
                  </mat-expansion-panel>
                </ng-container>
              </mat-accordion>

              <!-- =============================== -->
              <!-- Bloque: Horario para nuevos ingresos -->
              <!-- =============================== -->
              <div class="content-card" style="margin-top:12px;" formGroupName="nuevoIngreso">
                <h4 style="margin-top:0">üë∂ Horario para nuevos ingresos</h4>

                <div class="fila-top" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                  <mat-slide-toggle formControlName="activo">Activar horario de nuevos ingresos</mat-slide-toggle>

                  <mat-form-field appearance="outline">
                    <mat-label>Duraci√≥n (d√≠as)</mat-label>
                    <input matInput type="number" formControlName="duracionDias" min="1" max="180" [disabled]="!ni.value.activo">
                  </mat-form-field>

                  <mat-checkbox formControlName="aplicarSoloDiasActivosBase" [disabled]="!ni.value.activo">
                    Respetar d√≠as activos del horario base
                  </mat-checkbox>
                </div>

                <!-- Jornadas fijas de NI -->
                <div class="jornadas-wrap" formArrayName="jornadas">
                  <div class="fila-jornada"
                       *ngFor="let jCtrl of niJornadas.controls; let jIdx = index"
                       [formGroupName]="jIdx">

                    <mat-form-field appearance="outline">
                      <mat-label>Entrada</mat-label>
                      <input matInput formControlName="ini"
                             [ngxMatTimepicker]="pNiIni"
                             [format]="12"
                             placeholder="hh:mm AM/PM"
                             readonly
                             [disabled]="!ni.value.activo">
                      <button type="button" mat-icon-button matSuffix (click)="pNiIni.open()" [disabled]="!ni.value.activo">
                        <mat-icon>schedule</mat-icon>
                      </button>
                      <ngx-mat-timepicker #pNiIni></ngx-mat-timepicker>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Salida</mat-label>
                      <input matInput formControlName="fin"
                             [ngxMatTimepicker]="pNiFin"
                             [format]="12"
                             placeholder="hh:mm AM/PM"
                             readonly
                             [disabled]="!ni.value.activo">
                      <button type="button" mat-icon-button matSuffix (click)="pNiFin.open()" [disabled]="!ni.value.activo">
                        <mat-icon>schedule</mat-icon>
                      </button>
                      <ngx-mat-timepicker #pNiFin></ngx-mat-timepicker>
                    </mat-form-field>

                    <mat-checkbox formControlName="overnight" [disabled]="!ni.value.activo">
                      Cruza medianoche
                    </mat-checkbox>

                    <button type="button" mat-icon-button color="warn" aria-label="Quitar jornada"
                            (click)="removeNIJornada(jIdx)" [disabled]="!ni.value.activo">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>

                  <button type="button" class="btn btn--pill" (click)="addNIJornada()" [disabled]="!ni.value.activo">
                    + Agregar jornada
                  </button>
                </div>
              </div>

              <!-- Botones de guardar/limpiar -->
              <div class="acciones">
                <button type="button" mat-stroked-button color="warn" (click)="limpiar()">Limpiar</button>
                <button type="submit" mat-flat-button color="primary" [disabled]="form.invalid || guardando">
                  Guardar
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </mat-expansion-panel>
    </mat-accordion>

    <p></p>

    <!-- Lista de trabajadores -->
    <div class="card">
      <h3>üë• Trabajadores de esta sede</h3>

      <div class="search-container">
        <label class="search-label">üîç Buscar por nombre o apellido:</label>
        <mat-form-field appearance="fill" class="search-field">
          <mat-label>Buscar trabajador</mat-label>
          <input matInput [(ngModel)]="busquedaTrabajador" placeholder="Nombre o apellido" />
        </mat-form-field>
      </div>

      <table class="tabla-sedes">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let trabajador of trabajadoresFiltrados()">
            <td>{{ trabajador.id_checador }}</td>
            <td>{{ trabajador.nombre }}</td>
            <td>
              <button class="btn-view" (click)="verDetalleTrabajador(trabajador._id)">Ver</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Calendario de la sede -->
    <div class="card">
      <h3>üìÖ Calendario laboral de la sede</h3>
      <app-calendario-sede
        [sede]="sede.id"
        [sedeNombre]="sede.nombre"
        [anio]="anioActual"
        [eventos]="eventos"
        [todasLasSedes]="todasLasSedes"
        (eventoGuardado)="guardarEventoDesdeCalendario($event)"
        (eventoEliminado)="eliminarEventoDesdeCalendario($event)">
      </app-calendario-sede>

      <button class="btn btn--primary btn--block" routerLink="/calendario-laboral" *ngIf="!esSoloRevisor()">
        <i class="bi bi-calendar-plus"></i> Modificar en Calendario Laboral
      </button>
    </div>

    <!-- Acciones peligrosas -->
    <div class="card" *ngIf="esDios()">
      <h3 style="color: red;">‚ö†Ô∏è Acci√≥n peligrosa</h3>
      <p *ngIf="sede.estado === 'activa'">
        Este bot√≥n eliminar√° la sede y todos sus trabajadores. Aseg√∫rate de tener respaldo antes de continuar.
      </p>
      <p *ngIf="sede.estado === 'eliminacion_pendiente'">
        Esta sede est√° en proceso de eliminaci√≥n. Tienes 15 d√≠as para revertirlo antes de que se elimine permanentemente.
      </p>

      <button class="btn btn--danger btn--block" *ngIf="sede.estado === 'activa'" (click)="eliminarSede()">
        <i class="bi bi-trash-fill"></i> Eliminar Sede
      </button>

      <button class="btn-warning" *ngIf="sede.estado === 'eliminacion_pendiente'" (click)="cancelarEliminacionSede()">
        <i class="bi bi-arrow-counterclockwise"></i> Cancelar Eliminaci√≥n
      </button>
    </div>
  </main>
</div>
