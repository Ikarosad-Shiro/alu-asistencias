<div class="admin-dashboard-container">
  <!-- ğŸ“Œ BotÃ³n y fondo para el sidebar en mÃ³viles -->
  <button class="menu-toggle" (click)="toggleSidebar()">â˜°</button>
  <div class="sidebar-overlay" (click)="toggleSidebar()"></div>

  <!-- ğŸ“Œ Sidebar -->
  <div class="sidebar">
    <h3>Panel de Trabajadores</h3>
    <ul class="nav flex-column">
      <li class="nav-item"><button class="btn-sidebar" routerLink="/dashboard">ğŸ  Dashboard</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/sedes">ğŸ“ Sedes</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/trabajadores">ğŸ‘· Trabajadores</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/acerca-de">â„¹ï¸ Acerca de</button></li>
    </ul>
    <button class="btn-logout" (click)="cerrarSesion()">âŒ Cerrar SesiÃ³n</button>
  </div>

  <!-- ğŸ“Œ Contenido principal -->
  <div class="main-content">
    <div class="content-container">
      <!-- ğŸ“ Encabezado -->
      <div class="welcome-card">
        <h2>Lista de Trabajadores ğŸ‘·</h2>
        <p>Gestiona los trabajadores registrados en el sistema.</p>
      </div>

      <!-- ğŸ“Œ Motor de bÃºsqueda -->
      <div class="search-container">
        <select [(ngModel)]="filtroSede">
          <option value="">Todas las sedes</option>
          <option *ngFor="let sede of sedes" [value]="sede.id">{{ sede.nombre }}</option>
        </select>
        <input type="text" [(ngModel)]="filtroNombre" placeholder="Buscar por nombre..." />
        <button class="btn-buscar" (click)="filtrarTrabajadores()">ğŸ” Buscar</button>
      </div>

      <!-- ğŸŸ¢ Filtro por estado -->
      <div class="search-container">
        <label for="estado-select" style="font-weight: bold; margin-right: 8px;">
          Filtrar por estatus del trabajador:
        </label>
        <select id="estado-select" [(ngModel)]="estadoFiltro" (change)="filtrarTrabajadores()" class="estado-select">
          <option value="todos">Todos</option>
          <option value="activo">ğŸŸ¢ Activos</option>
          <option value="inactivo">ğŸ”´ Inactivos</option>
        </select>
      </div>

      <!-- ğŸ”» AcordeÃ³n: Formulario de alta (inicia cerrado) -->
      <mat-accordion class="add-worker-accordion">
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>â• Agregar trabajador (multisede)</mat-panel-title>
            <mat-panel-description>Alta, sede principal y sedes forÃ¡neas</mat-panel-description>
          </mat-expansion-panel-header>

          <!-- ğŸ“Œ Formulario para agregar trabajador (Multisede con casillas) -->
          <div class="add-worker-form card" *ngIf="rolUsuario !== 'Revisor'">
            <div class="form-grid">
              <!-- 1) Identidad -->
              <input type="text" class="full" [(ngModel)]="formAdd.nombre" placeholder="Nombre completo*" />


              <!-- 2) Sede principal / ForÃ¡neo -->
              <select [(ngModel)]="formAdd.sedePrincipal" (change)="onPrincipalChange()">
                <option [ngValue]="null" disabled>Seleccione sede principal*</option>
                <option *ngFor="let sedeItem of sedes" [ngValue]="sedeItem.id">{{ sedeItem.nombre }}</option>
              </select>

              <label class="inline right">
                <input type="checkbox" [(ngModel)]="formAdd.esForaneo" (change)="onToggleForaneo()" />
                Empleado forÃ¡neo
              </label>

              <!-- 3) Sedes forÃ¡neas -->
              <div *ngIf="formAdd.esForaneo" class="full">
                <label class="label">Sedes forÃ¡neas</label>

                <div class="foraneas-row">
                  <button type="button" class="btn-secondary" (click)="openSelectorForaneas()">Seleccionar sedesâ€¦</button>
                  <span class="contador">{{ formAdd.sedesForaneas.length }}/âˆ</span>
                </div>

                <div class="chips">
                  <span class="chip" *ngFor="let id of formAdd.sedesForaneas">
                    {{ obtenerNombreSede(+id) }}
                    <button class="chip-x" (click)="removerForanea(+id)">Ã—</button>
                  </span>
                  <span *ngIf="!formAdd.sedesForaneas.length" class="hint">Ninguna seleccionada.</span>
                </div>
              </div>

              <!-- 4) Nuevo ingreso / Fecha -->
              <label class="inline">
                <input type="checkbox" [(ngModel)]="formAdd.nuevoIngreso" (change)="onNuevoIngresoChange()" />
                Nuevo ingreso
              </label>
              <input
                type="date"
                [(ngModel)]="formAdd.fechaAlta"
                [disabled]="!formAdd.nuevoIngreso"
                [class.disabled-input]="!formAdd.nuevoIngreso" />

              <!-- 5) TelÃ©fonos -->
              <input type="text" [(ngModel)]="formAdd.telefono" placeholder="TelÃ©fono (opcional)" />
              <input type="text" [(ngModel)]="formAdd.telefonoEmergencia" placeholder="Tel. emergencia (opcional)" />

              <!-- 6) Correo (AHORA ABAJO y a lo ancho) -->
              <input type="email" class="full" [(ngModel)]="formAdd.correo" placeholder="Correo (opcional)" />

              <!-- 7) DirecciÃ³n -->
              <input type="text" class="full" [(ngModel)]="formAdd.direccion" placeholder="DirecciÃ³n (opcional)" />

              <!-- 8) Puesto -->
              <input type="text" [(ngModel)]="formAdd.puesto" placeholder="Puesto (opcional)" />
              <div class="spacer"></div>
            </div>

            <div *ngIf="errorForm" class="error-banner">âš ï¸ {{ errorForm }}</div>

            <div class="acciones">
              <button class="btn-agregar" (click)="abrirModalAgregar()">â• Agregar</button>
              <button class="btn-cancelar" (click)="resetFormAdd()">Limpiar</button>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>

      <!-- ğŸ“Œ Mat-card transparente para botÃ³n actualizar -->
      <div class="search-container transparente" style="justify-content: flex-end;">
        <div class="update-table-container">
          <button class="btn-update" (click)="actualizarTabla()">ğŸ”„ Actualizar Tabla</button>
        </div>
      </div>

      <!-- ğŸ“Œ Tabla de trabajadores -->
      <div class="user-table">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Sede</th>
              <th>Estado</th>
              <th>Estatus</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let trabajador of trabajadoresFiltrados">
              <td>{{ trabajador.nombre }}</td>
              <td>{{ obtenerNombreSede(trabajador.sede) }}</td>
              <td>
                <ng-container *ngIf="rolUsuario === 'Dios' || rolUsuario === 'Administrador'; else soloLectura">
                  <select
                    class="select-estado"
                    [value]="trabajador.sincronizado ? 'Sincronizado' : 'Pendiente'"
                    (focus)="guardarValorOriginal(trabajador)"
                    (change)="cambiarSincronizacion(trabajador, $event)">
                    <option value="Sincronizado">âœ… Sincronizado</option>
                    <option value="Pendiente">â³ Pendiente</option>
                  </select>
                </ng-container>

                <ng-template #soloLectura>
                  <span [ngClass]="{ 'activo': trabajador.sincronizado, 'pendiente': !trabajador.sincronizado }">
                    {{ trabajador.sincronizado ? 'âœ… Sincronizado' : 'â³ Pendiente' }}
                  </span>
                </ng-template>
              </td>

              <td>
                <span [ngClass]="trabajador.estado === 'inactivo' ? 'text-danger' : 'text-success'">
                  {{ trabajador.estado === 'inactivo' ? 'ğŸ”´ Inactivo' : 'ğŸŸ¢ Activo' }}
                </span>
              </td>
              <td class="btn-actions">
                <button class="btn-view" (click)="verTrabajador(trabajador._id!)">
                  <i class="fas fa-eye"></i> Ver
                </button>
              </td>
            </tr>
            <tr *ngIf="trabajadoresFiltrados.length === 0">
              <td colspan="5">ğŸ˜¢ No se encontraron trabajadores con esos criterios.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- =========================
           Selector ForÃ¡neas (panel fijo)
           ========================= -->
      <div class="selector-overlay" *ngIf="showSelectorForaneas" (click)="closeSelectorForaneas()"></div>

      <div class="selector-panel" *ngIf="showSelectorForaneas" role="dialog" aria-modal="true">
        <div class="selector-header">
          <h4>Seleccionar sedes forÃ¡neas</h4>
          <button class="close-x" (click)="closeSelectorForaneas()">Ã—</button>
        </div>

        <div class="selector-tools">
          <input
            type="text"
            [(ngModel)]="searchForanea"
            (input)="applyFilterForaneas()"
            placeholder="Buscar sedeâ€¦" />
          <button class="btn-mini" (click)="selectAllFiltered()" [disabled]="!filteredSedesForaneas.length">Seleccionar visibles</button>
          <button class="btn-mini" (click)="clearAllForaneas()" [disabled]="!formAdd.sedesForaneas.length">Limpiar</button>
        </div>

        <div class="selector-list">
          <label class="check-item" *ngFor="let s of filteredSedesForaneas">
            <input type="checkbox"
                   [checked]="isForaneaSelected(s.id)"
                   (change)="toggleForanea(s.id, $event)"
                   [disabled]="s.id === formAdd.sedePrincipal" />
            <span>{{ s.nombre }}</span>
            <small *ngIf="s.id === formAdd.sedePrincipal" class="muted">(principal)</small>
          </label>
        </div>

        <div class="selector-footer">
          <span class="muted">{{ formAdd.sedesForaneas.length }}/{{ maxForaneas }} seleccionadas</span>
          <button class="btn-primary" (click)="closeSelectorForaneas()">Listo</button>
        </div>
      </div>

      <!-- ğŸ“Œ Modal contraseÃ±a agregar -->
      <div class="modal" *ngIf="mostrarModalContrasena">
        <div class="modal-content">
          <h3>ğŸ”’ Ingresa tu contraseÃ±a</h3>
          <input type="password" [(ngModel)]="contrasena" placeholder="ContraseÃ±a" class="input-contraseÃ±a" />
          <div class="modal-buttons">
            <button class="btn-confirmar" (click)="confirmarAgregarTrabajador()">Confirmar</button>
            <button class="btn-cancelar" (click)="cerrarModalContrasena()">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- ğŸ“Œ Modal de mensajes -->
      <div class="modal" *ngIf="mostrarModalMensaje">
        <div class="modal-content" [ngClass]="{
          'modal-exito': tipoMensajeModal === 'exito',
          'modal-error': tipoMensajeModal === 'error',
          'modal-advertencia': tipoMensajeModal === 'advertencia'
        }">
          <h3 *ngIf="tipoMensajeModal === 'exito'">ğŸŸ¢ Ã‰xito</h3>
          <h3 *ngIf="tipoMensajeModal === 'error'">ğŸ”´ Error</h3>
          <h3 *ngIf="tipoMensajeModal === 'advertencia'">ğŸŸ¡ Advertencia</h3>
          <p>{{ mensajeModal }}</p>
          <button class="btn-cerrar" (click)="cerrarModalMensaje()">Aceptar</button>
        </div>
      </div>
    </div>
  </div>
</div>
