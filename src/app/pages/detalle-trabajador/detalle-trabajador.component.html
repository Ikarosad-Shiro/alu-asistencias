<div class="detalle-trabajador-container">

  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Panel de Trabajadores</h3>
    <ul class="nav flex-column">
      <li class="nav-item"><button class="btn-sidebar" routerLink="/dashboard">ğŸ  Dashboard</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/sedes">ğŸ“ Sedes</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/trabajadores">ğŸ‘· Trabajadores</button></li>
      <li class="nav-item"><button class="btn-sidebar" routerLink="/perfil">ğŸ‘¤ Perfil</button></li>
    </ul>
    <button class="btn-logout" (click)="cerrarSesion()">âŒ Cerrar SesiÃ³n</button>
  </div>

  <!-- Contenido Principal -->
  <div class="main-content">
    <div class="content-container">

      <!-- BotÃ³n de regresar y refrescar -->
     <div class="fila-extremos">
        <button class="btn-morado" (click)="regresar()">â¬… Regresar</button>
        <button class="btn-morado" (click)="refrescarVista()">ğŸ”„ Actualizar PÃ¡gina</button>
      </div>


      <!-- TÃ­tulo con nombre y sede -->
      <h2 class="titulo-nombre">ğŸ‘¤ {{ trabajador.nombre }}</h2>
      <div class="sedes-line" *ngIf="sedesChips.length > 0">
        <ng-container *ngFor="let s of sedesChips; trackBy: trackById">
          <span class="chip" [ngClass]="{ 'chip-principal': s.tipo === 'principal', 'chip-foranea': s.tipo === 'foranea' }">
            <span class="chip-ico">{{ s.tipo === 'principal' ? 'â­' : 'ğŸ·ï¸' }}</span>
            <span class="chip-text">{{ s.nombre }}</span>
          </span>
        </ng-container>
      </div>
      <p></p>

      <div class="botones-descarga">
        <button mat-raised-button color="warn" class="btn-descarga" (click)="abrirSelectorDeFechas()">
          ğŸ“„ Generar PDF
        </button>

        <button mat-raised-button color="primary" class="btn-descarga btn-excel" (click)="abrirSelectorDeFechasExcel()">
          ğŸ“Š Generar Excel
        </button>
      </div>

          <p></p>
    <!-- ğŸ“Œ InformaciÃ³n del Trabajador en un panel colapsable -->
    <mat-accordion>
      <mat-expansion-panel [expanded]="false" class="panel-transparente">
        <mat-expansion-panel-header>
          <mat-panel-title>
            ğŸ›  InformaciÃ³n del Trabajador
          </mat-panel-title>
        </mat-expansion-panel-header>

        <mat-card class="seccion-card">
          <mat-card-content>
            <div class="info-trabajador">
              <div class="info-campos">

                <label>Nombre:
                  <input type="text" [(ngModel)]="trabajador.nombre" [disabled]="rolUsuario === 'Revisor' || !modoEdicion">
                </label>

                <label>Correo:
                  <input type="email" [(ngModel)]="trabajador.correo" [disabled]="rolUsuario === 'Revisor' || !modoEdicion">
                </label>

                <label>TelÃ©fono:
                  <input type="text" [(ngModel)]="trabajador.telefono" [disabled]="rolUsuario === 'Revisor' || !modoEdicion">
                </label>

                <label>TelÃ©fono de Emergencia:
                  <input type="text" [(ngModel)]="trabajador.telefonoEmergencia" [disabled]="rolUsuario === 'Revisor' || !modoEdicion">
                </label>

                <label>DirecciÃ³n:
                  <input type="text" [(ngModel)]="trabajador.direccion" [disabled]="rolUsuario === 'Revisor' || !modoEdicion">
                </label>

                <label>Puesto:
                  <input type="text" [(ngModel)]="trabajador.puesto" [disabled]="rolUsuario === 'Revisor' || !modoEdicion">
                </label>

              </div>
              <!-- ğŸ¯ Botones visibles solo si NO es revisor -->
              <div class="botones" *ngIf="rolUsuario !== 'Revisor'">
                <button (click)="activarEdicion()" *ngIf="!modoEdicion" class="editar">
                  <i class="bi bi-pencil-fill"></i> Editar
                </button>
                <button (click)="actualizarTrabajador()" *ngIf="modoEdicion" class="actualizar">
                  <i class="bi bi-save-fill"></i> Actualizar
                </button>
                <button (click)="cancelarEdicion()" *ngIf="modoEdicion" class="cancelar">
                  <i class="bi bi-x-circle-fill"></i> Cancelar
                </button>
              </div>

            </div>
          </mat-card-content>
        </mat-card>
      </mat-expansion-panel>
    </mat-accordion>

    <p></p>
      <!-- ğŸ—“ ConfiguraciÃ³n de Calendario del Trabajador -->
      <mat-accordion>
        <mat-expansion-panel [expanded]="false" class="panel-transparente">
          <mat-expansion-panel-header>
            <mat-panel-title>ğŸ—“ ConfiguraciÃ³n de Calendario del Trabajador</mat-panel-title>
          </mat-expansion-panel-header>

          <mat-card class="seccion-card">
            <mat-card-content>
              <app-calendario-trabajador-visual
              *ngIf="trabajador && trabajador._id"
              [trabajadorId]="trabajador._id"
              [rolUsuario]="rolUsuario"
              (eventosActualizados)="actualizarEventosTrabajadorDesdeVisual($event)">
            </app-calendario-trabajador-visual>
            </mat-card-content>
          </mat-card>
        </mat-expansion-panel>
      </mat-accordion>

      <!-- ğŸ”’ Mensaje para Revisor -->
      <div class="mensaje-revisor" *ngIf="rolUsuario === 'Revisor'">
        ğŸ”’ Solo puedes visualizar los detalles del trabajador.
      </div>

     <!-- ğŸ“… Calendario del Trabajador -->
      <div class="calendario-container">
        <h3>ğŸ“… Calendario del Trabajador</h3>
          <app-calendario-unificado
            [asistencias]="asistenciasCalendario?.length ? asistenciasCalendario : trabajador.asistencias"
            [eventosSede]="eventosSede"
            [eventosTrabajador]="eventosTrabajador">
          </app-calendario-unificado>
      </div>

      <mat-card class="card-info mt-4">
        <mat-card-title>
          <span style="font-size: 1.3rem; display: flex; align-items: center;">
            ğŸ¢ <span style="margin-left: 8px;">Historial de Sedes</span>
          </span>
        </mat-card-title>

        <mat-card-content>
          <table mat-table [dataSource]="trabajador?.historialSedes || []" class="tabla-historial-sedes mat-elevation-z1">

            <!-- Sede -->
            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef> Sede </th>
              <td mat-cell *matCellDef="let sede">
                {{ sede.nombre || obtenerNombreSede(sede.idSede) }}
              </td>
            </ng-container>

            <!-- Desde -->
            <ng-container matColumnDef="fechaInicio">
              <th mat-header-cell *matHeaderCellDef> Desde </th>
              <td mat-cell *matCellDef="let sede"> {{ sede.fechaInicio | date:'dd/MM/yyyy' }} </td>
            </ng-container>

            <!-- Hasta -->
            <ng-container matColumnDef="fechaFin">
              <th mat-header-cell *matHeaderCellDef> Hasta </th>
              <td mat-cell *matCellDef="let sede">
                {{ sede.fechaFin ? (sede.fechaFin | date:'dd/MM/yyyy') : 'Actual' }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['nombre','fechaInicio','fechaFin']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['nombre','fechaInicio','fechaFin'];"></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <!-- ğŸ“Œ Opciones administrativas (al fondo) -->
      <div *ngIf="rolUsuario === 'Administrador' || rolUsuario === 'Dios'" class="acciones-admin-final">
        <h4>âš™ï¸ Acciones administrativas</h4>
        <p>Puedes cambiar la sede principal y administrar sedes forÃ¡neas o desactivar al trabajador.</p>
        <button class="btn btn-warning" (click)="cambiarSede()">ğŸ”„ Cambiar Sede (principal/forÃ¡neas)</button>
        <button class="btn btn-danger" (click)="desactivarTrabajador()">âŒ Desactivar Trabajador</button>
      </div>
    </div>
  </div>
</div>
